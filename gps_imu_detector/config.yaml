# GPS-IMU Anomaly Detector Configuration
# Complete configuration for Phases 0-5

# Dataset settings
data:
  euroc_path: "../data/euroc/all_sequences.csv"
  padre_path: "../data/PADRE_dataset"
  px4_path: "../data/px4_sitl"  # For transfer testing
  blackbird_path: "../data/blackbird"  # Additional transfer dataset

  # Sequence-wise split (LOSO-CV)
  cv_folds: 5
  test_sequences: ["V1_02_medium"]  # Hold-out for final eval

  # Sampling
  sample_rate_hz: 200
  dt: 0.005

# Feature extraction (Phase 1-2)
features:
  # Multi-scale windows (in samples at 200Hz)
  windows: [5, 10, 25, 50, 100, 200]

  # Feature types
  use_mean: true
  use_std: true
  use_max: true
  use_cumsum: true

  # Streaming mode for real-time
  streaming: true

# Physics residuals (Phase 1-2)
physics:
  # Analytic constraints
  use_bounded_jerk: true
  max_jerk: 100.0  # m/s^3

  use_energy_conservation: true
  energy_tolerance: 0.1

  use_pos_vel_acc_consistency: true

  # PINN (optional, CPU budget permitting)
  use_pinn: true
  pinn_hidden_size: 64
  pinn_num_layers: 2
  pinn_checkpoint: null  # Path to pretrained PINN

# EKF settings (Phase 1-2)
ekf:
  # State: [pos(3), vel(3), attitude(3), gyro_bias(3), accel_bias(3)]
  state_dim: 15

  # Process noise
  process_noise_pos: 0.01
  process_noise_vel: 0.1
  process_noise_att: 0.01
  process_noise_bias: 0.001

  # Measurement noise
  meas_noise_pos: 0.1
  meas_noise_vel: 0.05

  # NIS threshold (chi-squared)
  nis_dof: 6
  nis_alpha: 0.05

# ML detector model (Phase 1-2)
model:
  # Architecture: 1D CNN + GRU
  cnn_channels: [32, 64]
  cnn_kernel_size: 3

  gru_hidden_size: 64
  gru_num_layers: 1

  # Output
  num_classes: 1  # Binary anomaly detection

  # Regularization
  dropout: 0.1

# Hybrid scoring (Phase 1-2)
scoring:
  # Weights (calibrated on validation)
  weight_pinn: 0.25
  weight_ekf_nis: 0.25
  weight_ml: 0.25
  weight_temporal: 0.25

  # Normalization
  normalize_scores: true

# Training (Phase 1-2)
training:
  batch_size: 64
  learning_rate: 0.001
  epochs: 100
  early_stopping_patience: 10

  # Contamination (domain prior, NOT tuned on attacks)
  contamination: 0.05

  # Hard negative mining
  hard_negative_ratio: 0.2

  # Seeds for reproducibility
  seed: 42

# Attack generation (Phase 1-2)
attacks:
  types:
    - bias
    - drift
    - ramp
    - noise
    - coordinated
    - intermittent

  # Magnitude ranges
  magnitudes: [0.1, 0.25, 0.5, 1.0, 2.0, 4.0]

  # Stealth parameters
  stealth:
    ar1_coefficient: 0.99  # For slow drift
    ramp_duration_s: 10.0
    intermittent_prob: 0.1

# Phase 3: Hardening and Robustness
hardening:
  # Hard negative mining
  hard_negatives:
    n_attempts: 20
    target_evasion: 0.9
    attack_types:
      - ar1_drift_slow
      - ar1_drift_medium
      - coordinated_high
      - coordinated_med
      - intermittent_sparse
      - intermittent_dense
      - below_threshold

  # Adversarial training
  adversarial:
    enabled: true
    epsilon_values: [0.01, 0.05, 0.1, 0.2]
    pgd_steps: 20
    step_size: 0.01

  # Domain randomization
  domain_randomization:
    enabled: true
    noise_scale_range: [0.5, 2.0]
    jitter_std: 0.001
    augment_prob: 0.5

  # Transfer evaluation
  transfer:
    source_dataset: "euroc"
    target_datasets: ["px4_sitl", "blackbird"]
    compute_mmd: true
    compute_coral: true

  # Attribution heads
  attribution:
    attack_types: 7  # Number of attack type classes
    n_sensors: 5  # Number of sensor groups

  # Curriculum learning
  curriculum:
    enabled: true
    n_iterations: 5
    hard_negative_sample_ratio: 0.3

# Phase 4: Quantization and Optimization
optimization:
  # Quantization
  quantize: true
  quantize_bits: 8
  quantize_method: "dynamic"  # dynamic, static

  # Target latency
  target_latency_ms: 5.0

  # Export formats
  export_onnx: true
  export_torchscript: true
  export_tflite: false

  # Latency benchmarking
  benchmark:
    warmup_iterations: 10
    benchmark_iterations: 100

  # Streaming inference
  streaming:
    buffer_size: 1
    maintain_hidden_state: true

# Phase 5: Rigorous Evaluation
evaluation:
  # Metrics at fixed FPR
  fpr_thresholds: [0.01, 0.05, 0.10]

  # Bootstrap for confidence intervals
  bootstrap_samples: 100
  confidence_level: 0.95

  # Per-attack breakdown
  report_per_attack: true
  report_worst_case: true

  # Detection delay
  compute_detection_delay: true

  # Ablation studies
  ablation:
    enabled: true
    variants:
      - name: "full_model"
        cnn_channels: [32, 64]
        gru_hidden_size: 64
      - name: "small_cnn"
        cnn_channels: [16, 32]
        gru_hidden_size: 64
      - name: "small_all"
        cnn_channels: [16, 32]
        gru_hidden_size: 32

  # Output
  output_format: "json"
  save_fold_results: true

# Logging
logging:
  level: INFO
  save_dir: "./experiments"
  save_models: true
  save_plots: true
